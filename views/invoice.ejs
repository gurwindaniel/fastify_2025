<%- include('./partials/header') %>

<div class="container mt-5">
  <div class="row">
    <div class="col-lg-8 mx-auto">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h3 class="mb-0"><i class="bi bi-file-earmark-text"></i> Create Invoice</h3>
        </div>
        <div class="card-body">

          <% if (message) { %>
            <div class="alert alert-success"><%= message %></div>
          <% } %>
          <% if (error) { %>
            <div class="alert alert-danger"><%= error %></div>
          <% } %>

          <form id="invoiceForm" method="POST" action="/invoice/create">

            <div class="mb-3">
              <label for="customer_address_id" class="form-label">Customer Address</label>
              <select id="customer_address_id" name="customer_address_id" class="form-select" required>
                <option value="">-- Select Customer Address --</option>
                <% customerAddresses.forEach(c => { %>
                  <option value="<%= c.address_id %>"><%= c.address_name %></option>
                <% }) %>
              </select>
            </div>

            <div class="mb-3">
              <label for="vendor_address_id" class="form-label">Vendor Address (optional)</label>
              <select id="vendor_address_id" name="vendor_address_id" class="form-select">
                <option value="">-- Select Vendor (to filter products) --</option>
                <% vendorAddresses.forEach(v => { %>
                  <option value="<%= v.address_id %>"><%= v.address_name %></option>
                <% }) %>
              </select>
              <div class="form-text">Selecting a vendor will show only products received from that vendor.</div>
            </div>

            <div class="mb-3">
              <label for="product_id" class="form-label">Product</label>
              <select id="product_id" name="product_id" class="form-select" required>
                <option value="">-- Select Product --</option>
                <% if (products && products.length) { %>
                  <% products.forEach(p => { %>
                    <option value="<%= p.product_id %>"><%= p.product_name %></option>
                  <% }) %>
                <% } %>
              </select>
            </div>

            <div class="mb-3">
              <label for="sale_quantity" class="form-label">Quantity</label>
              <input type="number" min="1" step="1" id="sale_quantity" name="sale_quantity" class="form-control" required />
            </div>

            <div class="mb-3">
              <label for="sale_amount" class="form-label">Amount (â‚¹)</label>
              <input type="number" min="0" step="0.01" id="sale_amount" name="sale_amount" class="form-control" required />
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary">Create Invoice</button>
              <a href="/invoice/list" class="btn btn-secondary">View Invoices</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // When vendor changes, fetch products that were received from that vendor
  document.getElementById('vendor_address_id').addEventListener('change', async function () {
    const vendorId = this.value;
    const prodSelect = document.getElementById('product_id');
    prodSelect.innerHTML = '<option value="">-- Select Product --</option>';

    if (!vendorId) return;

    try {
      const res = await fetch(`/invoice/vendor-products?vendor_id=${vendorId}`);
      const data = await res.json();
      if (Array.isArray(data) && data.length) {
        data.forEach(p => {
          const opt = document.createElement('option');
          opt.value = p.product_id;
          opt.textContent = p.product_name;
          prodSelect.appendChild(opt);
        });
      } else {
        // no products
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No products found for this vendor';
        prodSelect.appendChild(opt);
      }
    } catch (err) {
      console.error(err);
    }
  });
</script>

<%- include('./partials/footer') %>
